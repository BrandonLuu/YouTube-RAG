from langchain_community.document_loaders import WebBaseLoader
from langchain_core.documents import Document
from langchain_core.prompts import ChatPromptTemplate
from langchain_mongodb import MongoDBAtlasVectorSearch
from langchain_ollama import OllamaLLM, OllamaEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter, RecursiveJsonSplitter
from pymongo import MongoClient, InsertOne
from typing_extensions import List, TypedDict

import bs4
import json
from youtube_fetcher import get_channel_analytics

from config import MONGO_DB_PASSWORD


# Embeddings Settings
embeddings = OllamaEmbeddings(model="llama3.2")
llm = OllamaLLM(model='llama3.2')

# MongoDB Settings
DB_NAME = "yt_db"
EMBEDDINGS_COLLECTION_NAME = "yt_embeddings"
ATLAS_VECTOR_SEARCH_INDEX_NAME = "yt_index"

mongo_uri = f"mongodb+srv://admin:{MONGO_DB_PASSWORD}@cluster0.0xcvi.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0"
mongo_client = MongoClient(mongo_uri)
mongo_collection = mongo_client[DB_NAME][EMBEDDINGS_COLLECTION_NAME]

vector_store = MongoDBAtlasVectorSearch(
    embedding=embeddings,
    collection=mongo_collection,
    index_name=ATLAS_VECTOR_SEARCH_INDEX_NAME,
    relevance_score_fn="cosine",
)

# !! IMPORTANT: EITHER RUN THIS CODE ONCE OR MANUALLY ADD VECTOR SEARCH IN ATLAS UI - FAILS ON DUPE CALLS
# 3072 is the dimension for Llama3.2 - model dimensions must match search index 
# vector_store.create_vector_search_index(dimensions=3072)
# {
#   "fields": [
#     {
#       "numDimensions": 3072,
#       "path": "embedding",
#       "similarity": "cosine",
#       "type": "vector"
#     }
#   ]
# }

def get_data_from_url(url):
    """
    Fetch the webpage data and add to vector store
    """
    print(url)
    # Load and chunk contents of the blog
    loader = WebBaseLoader(
        web_paths=(url,),
        bs_kwargs=dict(
            parse_only=bs4.SoupStrainer(
                # class_=("post-content", "post-title", "post-header")
            )
        ),
    )
    docs = loader.load()

    # Index chunks
    text_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=200)

    all_splits = text_splitter.split_documents(docs)
    # print(f"split: {all_splits[0]}")

    doc_ids = vector_store.add_documents(documents=all_splits)
    # print(doc_ids)

def test_load_channel_stats():
    print("Loading test JSON Channel Stats")

    # convert text to JSON
    text = {'username': '@Channel5YouTube', 'channel_id': 'UC-AQKm7HUNMmxjdS371MSwg', 'channel_statistics': {'viewCount': '233328383', 'subscriberCount': '2870000', 'hiddenSubscriberCount': False, 'videoCount': '91'}, 'videos': [{'id': 'yiW_dfnaeEQ', 'title': 'LA Wildfires', 'description': 'Email to reach Estrada and family: estrada_s@yahoo.com\nZelle to send funds to Ms. Espinoza, who we interviewed at the end: l_espinoza68@yahoo.com', 'publishedAt': '2025-01-10T22:55:41Z', 'statistics': {'viewCount': '1554134', 'likeCount': '58952', 'favoriteCount': '0', 'commentCount': '6718'}}, {'id': 'WBwGX2ky3BQ', 'title': 'Justice for J6 Rally (Dear Kelly Scene)', 'description': "This is a scene from our upcoming movie, 'Dear Kelly,' which will release on January 15: https://youtu.be/6Nb7NNUlsHM", 'publishedAt': '2025-01-06T20:25:59Z', 'statistics': {'viewCount': '342992', 'likeCount': '9974', 'favoriteCount': '0', 'commentCount': '1832'}}]}

    # Create a JSON splitter, create the doc, add to vector DB
    json_splitter = RecursiveJsonSplitter()
    json_doc = json_splitter.create_documents([text])
    doc_ids = vector_store.add_documents(json_doc)


def get_and_load_channel_analytics(channel_name):
    print(f"Fetching and Adding Channel Stats for {channel_name}")

    # analytics = get_channel_analytics(channel_name)
    analytics = {"_id":{"$oid":"67860ab71a38471e52c9cc26"},"text":"{\"username\": \"@Channel5YouTube\", \"channel_id\": \"UC-AQKm7HUNMmxjdS371MSwg\", \"channel_statistics\": {\"viewCount\": \"234423303\", \"subscriberCount\": \"2870000\", \"hiddenSubscriberCount\": false, \"videoCount\": \"91\"}, \"videos\": [{\"id\": \"Zmc5-B5AFpk\", \"title\": \"White Lives Matter Rally\", \"description\": \"DEAR KELLY will premiere in three days at 5:55 P.M. EST at https://www.dearkellyfilm.com/ for $5.55/rental.\", \"publishedAt\": \"2025-01-12T20:10:21Z\", \"statistics\": {\"viewCount\": \"839210\", \"likeCount\": \"26462\", \"favoriteCount\": \"0\", \"commentCount\": \"5902\"}}, {\"id\": \"yiW_dfnaeEQ\", \"title\": \"LA Wildfires\", \"description\": \"Email to reach Estrada and family: estrada_s@yahoo.com\\nZelle to send funds to Ms. Espinoza, who we interviewed at the end: l_espinoza68@yahoo.com\", \"publishedAt\": \"2025-01-10T22:55:41Z\", \"statistics\": {\"viewCount\": \"1571259\", \"likeCount\": \"59286\", \"favoriteCount\": \"0\", \"commentCount\": \"6731\"}}, {\"id\": \"WBwGX2ky3BQ\", \"title\": \"Justice for J6 Rally (Dear Kelly Scene)\", \"description\": \"This is a scene from our upcoming movie, 'Dear Kelly,' which will release on January 15: https://youtu.be/6Nb7NNUlsHM\", \"publishedAt\": \"2025-01-06T20:25:59Z\", \"statistics\": {\"viewCount\": \"343789\", \"likeCount\": \"9986\", \"favoriteCount\": \"0\", \"commentCount\": \"1833\"}}, {\"id\": \"6Nb7NNUlsHM\", \"title\": \"Dear Kelly (Official Movie Trailer)\", \"description\": \"This is the official trailer for Andrew Callaghan's sophomore film, \\\"Dear Kelly,' an independent project that will be available exclusively for streaming at https://www.dearkellyfilm.com on January 15, 2025.\", \"publishedAt\": \"2025-01-03T20:45:10Z\", \"statistics\": {\"viewCount\": \"374270\", \"likeCount\": \"14951\", \"favoriteCount\": \"0\", \"commentCount\": \"748\"}}, {\"id\": \"ZlAZhoebEUk\", \"title\": \"Luigi Supporter Speaks on Healthcare Claim Denials\", \"description\": \"This is a short from our full video, 'Free Luigi Rally,' which is currently live on our channel: https://youtu.be/iFAKkquGTxs\", \"publishedAt\": \"2024-12-28T21:23:07Z\", \"statistics\": {\"viewCount\": \"65940\", \"likeCount\": \"3383\", \"favoriteCount\": \"0\", \"commentCount\": \"430\"}}, {\"id\": \"iFAKkquGTxs\", \"title\": \"Free Luigi Rally\", \"description\": \"To donate to Nicolas GoFundMe, head over to: https://www.gofundme.com/f/save-nicholas-zamudio-from-eviction-and-pain\\n\\nTo see our uncut, uncensored interview with Ken Klippenstein, head over to: https://www.patreon.com/channel5\\n\\nTo subscribe to our new Spanish-language, translation channel, head over to: https://m.youtube.com/@CanalCincoNews\", \"publishedAt\": \"2024-12-27T19:14:14Z\", \"statistics\": {\"viewCount\": \"1736747\", \"likeCount\": \"83860\", \"favoriteCount\": \"0\", \"commentCount\": \"11613\"}}, {\"id\": \"D8w7sozqDZ0\", \"title\": \"Israel-Hezbollah Conflict\", \"description\": \"If you are able to, please donate to 'Katie's Fist,' a direct fundraiser that supports internally displaced refugees in Lebanon: https://www.gofundme.com/f/julias-fist?utm_source=whatsapp&utm_medium=customer&utm_campaign=man_sharesheet_ft&attribution_id=sl%3A6c239e2a-f32a-414f-b047-c21dbc00d690.\", \"publishedAt\": \"2024-12-18T17:29:44Z\", \"statistics\": {\"viewCount\": \"820562\", \"likeCount\": \"32140\", \"favoriteCount\": \"0\", \"commentCount\": \"5215\"}}, {\"id\": \"WUpSpx8bn5Y\", \"title\": \"Dunkin' Donuts Workers Strike\", \"description\": \"Go to https://ground.news/channel5 to stay fully informed with all sides of every story on US Politics and more. Subscribe for 50% off through my link to the Vantage plan.\", \"publishedAt\": \"2024-12-13T17:00:05Z\", \"statistics\": {\"viewCount\": \"1125362\", \"likeCount\": \"26648\", \"favoriteCount\": \"0\", \"commentCount\": \"8774\"}}, {\"id\": \"Z5kmE2lC2_o\", \"title\": \"West Virginia Snake Church\", \"description\": \"To see our new episode, 'West Virginia Greyhound Racing,' go to our Patreon, https://www.patreon.com/channel5\", \"publishedAt\": \"2024-12-06T17:45:23Z\", \"statistics\": {\"viewCount\": \"1498125\", \"likeCount\": \"30745\", \"favoriteCount\": \"0\", \"commentCount\": \"4442\"}}, {\"id\": \"T8eUheS9GaU\", \"title\": \"Kamala Harris Election Loss\", \"description\": \"\\ud83c\\udf0f Get exclusive NordVPN deal here \\u27b5  https://NordVPN.com/channel5 It\\u2019s risk free with Nord\\u2019s 30 day money-back guarantee! \\u270c\", \"publishedAt\": \"2024-11-12T18:46:04Z\", \"statistics\": {\"viewCount\": \"1716693\", \"likeCount\": \"56732\", \"favoriteCount\": \"0\", \"commentCount\": \"11880\"}}, {\"id\": \"_aDM_rmt0hI\", \"title\": \"Election Day\", \"description\": \"Here is our coverage of the scene outside The White House on November 5, 2024, just hours before Trump won a decisive victory over Harris.\", \"publishedAt\": \"2024-11-06T20:45:51Z\", \"statistics\": {\"viewCount\": \"1618332\", \"likeCount\": \"51841\", \"favoriteCount\": \"0\", \"commentCount\": \"8901\"}}, {\"id\": \"lZKGBOWAICc\", \"title\": \"Biden's Apology to Native Americans\", \"description\": \"Go to https://ground.news/channel5 to stay fully informed with all sides of every story on the U.S. Election and more. Save 50% on unlimited access to their Vantage plan through my link.\", \"publishedAt\": \"2024-11-04T16:46:42Z\", \"statistics\": {\"viewCount\": \"874586\", \"likeCount\": \"38075\", \"favoriteCount\": \"0\", \"commentCount\": \"6066\"}}, {\"id\": \"4YFLAk-pyzQ\", \"title\": \"Pennsylvania, a Swing State\", \"description\": \"Go to https://ground.news/channel5 to stay fully informed with all sides of every story on the U.S. Election and more. Save 50% on unlimited access to their Vantage plan through my link.\", \"publishedAt\": \"2024-10-30T17:14:09Z\", \"statistics\": {\"viewCount\": \"1636639\", \"likeCount\": \"47497\", \"favoriteCount\": \"0\", \"commentCount\": \"7031\"}}, {\"id\": \"QKK36CgorZw\", \"title\": \"C5 Confessional Booth\", \"description\": \"Here is an edit from our first-ever, live action interview installation at Superchief Gallery in Los Angeles, CA. If you'd like to see a full reel of uncensored confessions, go to our Patreon,  https://www.patreon.com/channel5.\\n\\nAlso, the confessional will re-open to the public on October 25 from 7-10 p.m. So if you\\u2019d like to confess, head to Superchief Gallery at 1965 S Los Angeles Street this Friday!\", \"publishedAt\": \"2024-10-23T18:21:20Z\", \"statistics\": {\"viewCount\": \"1508923\", \"likeCount\": \"44814\", \"favoriteCount\": \"0\", \"commentCount\": \"6406\"}}, {\"id\": \"BwI9gn6XQD0\", \"title\": \"Hunt for the Jersey Devil\", \"description\": \"In this video, we explore the folklore and whereabouts of South Jersey's famous cryptid, the 'Jersey Devil.'\", \"publishedAt\": \"2024-10-20T17:30:09Z\", \"statistics\": {\"viewCount\": \"1013991\", \"likeCount\": \"25488\", \"favoriteCount\": \"0\", \"commentCount\": \"2310\"}}, {\"id\": \"HzJwOdCisdo\", \"title\": \"Tijuana Red Light District\", \"description\": \"Get an exclusive 15% discount on Saily data plans! Use code channel5 at checkout. Download Saily app or go to https://saily.com/channel5 \\u26f5\\n\\nAlso, here\\u2019s the link to Canal Cinco: https://m.youtube.com/@CanalCincoNews\", \"publishedAt\": \"2024-10-16T17:40:39Z\", \"statistics\": {\"viewCount\": \"2101598\", \"likeCount\": \"53805\", \"favoriteCount\": \"0\", \"commentCount\": \"3570\"}}, {\"id\": \"mZDQw2K8AfM\", \"title\": \"Stacey Haslett\\u2019s Bigfoot Portal\", \"description\": \"To see our new episode, 'Hunt for the Jersey Devil,' go to our Patreon, https://www.patreon.com/channel5. As many of you know, we area a  completely independent and primarily crowdfunded operation that relies on your $5 monthly subscriptions to keep the 5 in motion.\", \"publishedAt\": \"2024-10-13T20:23:23Z\", \"statistics\": {\"viewCount\": \"780852\", \"likeCount\": \"25821\", \"favoriteCount\": \"0\", \"commentCount\": \"3158\"}}, {\"id\": \"tAMNPeo7AG0\", \"title\": \"Mexico City Gentrification\", \"description\": \"Here is our coverage of gentrification in Mexico City, hosted by our new correspondent, Josue. \\n\\nTo watch our new episode, \\u2018Tijuana Red Light District,\\u2019 go to our Patreon, http://www.patreon.com/channel5. \\n\\nAlso, our Spanish-Language channel, \\u2018Canal Cinco con Andr\\u00e9s Callaghan is live at @CanalCincoNews\\n\\nAudio mixing by Carlos Bueno @BuenoSounds\", \"publishedAt\": \"2024-10-09T17:30:04Z\", \"statistics\": {\"viewCount\": \"2593203\", \"likeCount\": \"87953\", \"favoriteCount\": \"0\", \"commentCount\": \"9850\"}}, {\"id\": \"iP7SbP-Qxjw\", \"title\": \"Pennsylvania Bigfoot Conference\", \"description\": \"Here is our coverage of the Pennsylvania Bigfoot and Paranormal Expo in Jefferson County, Pennsylvania. As many of you know, we are completely independent and primarily crowd-funded by $5 monthly Patreon subscriptions, where we post exclusive, early uncensored content. If you'd like to support us and see our exclusive episode 'Pennsylvania Bigfoot Conference,' please sign up: https://www.patreon.com/channel5\", \"publishedAt\": \"2024-09-30T22:28:26Z\", \"statistics\": {\"viewCount\": \"1605507\", \"likeCount\": \"42955\", \"favoriteCount\": \"0\", \"commentCount\": \"4694\"}}, {\"id\": \"yC0R3mTRs-4\", \"title\": \"Tel Aviv Protests (Israel)\", \"description\": \"Visit https://ground.news/channel5 to stay fully informed and get all sides of every story. Save 40% on their unlimited access Vantage plan with our link.\", \"publishedAt\": \"2024-09-27T21:58:25Z\", \"statistics\": {\"viewCount\": \"990213\", \"likeCount\": \"31169\", \"favoriteCount\": \"0\", \"commentCount\": \"6343\"}}, {\"id\": \"Mg9WWZTXKuE\", \"title\": \"Aurora Migrant Gang 'Takeover'\", \"description\": \"Here is our coverage of the ongoing situation in Aurora, Colorado, regarding a series of apartment complexes allegedly taken over by a Venezuelan gang called Tren De Aragua. As many of you know, we are completely independent and primarily crowd-funded by $5 monthly Patreon subscriptions, where we post exclusive, early uncensored content. If you'd like to support us, please sign up: https://www.patreon.com/channel5.\", \"publishedAt\": \"2024-09-20T17:54:39Z\", \"statistics\": {\"viewCount\": \"2077000\", \"likeCount\": \"66571\", \"favoriteCount\": \"0\", \"commentCount\": \"11492\"}}, {\"id\": \"UYbysevC8NQ\", \"title\": \"Crip Mac Sentencing\", \"description\": \"To watch our newest episode, 'Venezuelan Migrant Gang 'Takeover,' go to our Patreon, https://www.patreon.com/channel5. As many of you know, we are completely independent and crowdfunded. Your support means a lot!\", \"publishedAt\": \"2024-09-08T19:18:01Z\", \"statistics\": {\"viewCount\": \"1870979\", \"likeCount\": \"51134\", \"favoriteCount\": \"0\", \"commentCount\": \"6992\"}}, {\"id\": \"4k5GqsOA7vk\", \"title\": \"Arizona Trump Rally\", \"description\": \"Go to https://ground.news/channel5 to stay fully informed with 2024 Elections and more. Save 40% on their unlimited access Vantage plan with my link this month.\\n\\n0:00-0:33: Rally Intro\\n0:33-2:37: Woman's Abortion Experience\\n2:27-3:27: Why They Vote Trump\\n3:27-4:21: Kamala's Lack of Experience\\n4:25-5:26: LARRY SUSAN\\n5:26-5:37: Gas Price Concerns\\n5:51-7:04: Tampons in Boys Bathrooms \\n7:21-8:36: Migrant Crime and Drugs\\n8:37-10:02: Ad Read\\n10:02-10:52: Counter-Protestor\\n10:52-12:28: Jews for Trump\\n12:28-13:33: Has Kamala Been to Border?\\n13:34-14:42: Closing Thoughts From Scientist\", \"publishedAt\": \"2024-09-03T20:30:22Z\", \"statistics\": {\"viewCount\": \"1519637\", \"likeCount\": \"37817\", \"favoriteCount\": \"0\", \"commentCount\": \"11453\"}}, {\"id\": \"lcPsy8734Vg\", \"title\": \"Havasupai Uranium Mine Protest\", \"description\": \"Here's our coverage of the Havasupai-led protests of the Pinyon Plain Uranium Mine in Northern Arizona. \\n\\nTo book a stay and support the Havasupai tourist economy, visit https://theofficialhavasupaitribe.com/\\n\\nTo get involved with 'Haul No,' visit https://haulno.com/\", \"publishedAt\": \"2024-08-31T17:26:04Z\", \"statistics\": {\"viewCount\": \"716318\", \"likeCount\": \"31606\", \"favoriteCount\": \"0\", \"commentCount\": \"3501\"}}, {\"id\": \"gtXmnaj4VA4\", \"title\": \"Planned Parenthood Abortion Bus (DNC)\", \"description\": \"Use code channel5 at https://incogni.com/channel5 to get an exclusive 60% off an annual Incogni plan.\", \"publishedAt\": \"2024-08-28T18:04:22Z\", \"statistics\": {\"viewCount\": \"985094\", \"likeCount\": \"28083\", \"favoriteCount\": \"0\", \"commentCount\": \"6216\"}}, {\"id\": \"cVap_ky3VTI\", \"title\": \"RFK Jr. Rally (DNC)\", \"description\": \"https://NordVPN.com/channel5 - It\\u2019s risk free with Nord\\u2019s 30 day money-back guarantee!\", \"publishedAt\": \"2024-08-23T19:57:15Z\", \"statistics\": {\"viewCount\": \"1059243\", \"likeCount\": \"35493\", \"favoriteCount\": \"0\", \"commentCount\": \"5876\"}}, {\"id\": \"-ik5KDukIho\", \"title\": \"Poor People's Army (DNC)\", \"description\": \"GET 1GB DATA FOR FREE! Go to https://Saily.com/channel5 and download Saily to test it out!\", \"publishedAt\": \"2024-08-22T17:54:01Z\", \"statistics\": {\"viewCount\": \"1343047\", \"likeCount\": \"61123\", \"favoriteCount\": \"0\", \"commentCount\": \"7068\"}}, {\"id\": \"x4_vBP-faQM\", \"title\": \"Palestine March (DNC)\", \"description\": \"Go to https://ground.news/channel5 to stay fully informed on the 2024 elections key issues and candidates. Save 40% on their unlimited access Vantage plan with my link this month.\", \"publishedAt\": \"2024-08-20T23:12:34Z\", \"statistics\": {\"viewCount\": \"1098511\", \"likeCount\": \"61752\", \"favoriteCount\": \"0\", \"commentCount\": \"9886\"}}, {\"id\": \"9C8G6dRAqUU\", \"title\": \"U.K. Riots\", \"description\": \"Channel 5 is officially worldwide. Here is our coverage of the ongoing anti-migrant protests in Liverpool, England following the murder of three young girls in Southport, as well as counter-protests organized by leftists and members of the Islamic Community. Shoutout to Sanjay and Graeme for getting this footage.\", \"publishedAt\": \"2024-08-10T22:56:53Z\", \"statistics\": {\"viewCount\": \"3500800\", \"likeCount\": \"105343\", \"favoriteCount\": \"0\", \"commentCount\": \"32858\"}}, {\"id\": \"pJNACvJ9CgY\", \"title\": \"Donald Trump Assassination Attempt\", \"description\": \"Here is our video interviewing on-scene eyewitnesses in Butler, PA in the immediate aftermath of the assassination attempt on Donald Trump's life, which resulted in a bullet grazing his ear. As mentioned, we are currently on tour screening our new documentary film, 'Dear Kelly.' If you'd like to buy tickets for our upcoming screenings this week in Tucson, San Diego, Tacoma, Portland, or Los Angeles, visit the link here: https://channel5.news/pages/untitled-film-tour.\", \"publishedAt\": \"2024-07-17T21:09:35Z\", \"statistics\": {\"viewCount\": \"2001622\", \"likeCount\": \"70442\", \"favoriteCount\": \"0\", \"commentCount\": \"5978\"}}, {\"id\": \"lfqerR3d7hQ\", \"title\": \"Davis Clarke\", \"description\": \"This episode is sponsored by Ground News. Go to https://ground.news/channel5 to subscribe to the unlimited access Vantage subscription that brings the price down to about $5 a month\\n\\nAlso, tickets to the upcoming private screenings of 'Dear Kelly' are available at https://channel5.news/pages/untitled-film-tour.\\n\\nIf you'd like to see our full interview with Yung Gravy x Davis Clarke, go to our Patreon, https://www.patreon.com/channel5.\", \"publishedAt\": \"2024-06-06T23:30:01Z\", \"statistics\": {\"viewCount\": \"1533827\", \"likeCount\": \"47984\", \"favoriteCount\": \"0\", \"commentCount\": \"5913\"}}, {\"id\": \"BTD1qDBZSzw\", \"title\": \"Folsom Street Fair (Age-Restricted 5/24)\", \"description\": \"This video was filmed in 2021, but never released on YouTube. By the grace of god, YouTube has somehow approved this to be released, so here it is.\", \"publishedAt\": \"2024-05-09T19:11:35Z\", \"statistics\": {\"viewCount\": \"621862\", \"likeCount\": \"19079\", \"favoriteCount\": \"0\", \"commentCount\": \"2709\"}}, {\"id\": \"DJA7jDF7bLE\", \"title\": \"Connecticut Kia Boyz\", \"description\": \"Here's our new video. Get the exclusive NordVPN deal here:  https://NordVPN.com/channel5 It\\u2019s risk free with Nord\\u2019s 30 day money-back guarantee!\", \"publishedAt\": \"2024-04-19T17:02:01Z\", \"statistics\": {\"viewCount\": \"5767880\", \"likeCount\": \"126645\", \"favoriteCount\": \"0\", \"commentCount\": \"19708\"}}, {\"id\": \"AbeZsgY67sU\", \"title\": \"D.A.R.E. Conference\", \"description\": \"This is our coverage of the international D.A.R.E. Conference in Las Vegas, Nevada. Use code channel5 at http://incogni.com/channel5 to get an exclusive 60% off the annual plan!\", \"publishedAt\": \"2024-04-12T19:29:19Z\", \"statistics\": {\"viewCount\": \"2372061\", \"likeCount\": \"58345\", \"favoriteCount\": \"0\", \"commentCount\": \"9899\"}}, {\"id\": \"s3YasV2zUro\", \"title\": \"Vegas Tunnels Video Takedown\", \"description\": \"UPDATE: this video has been reinstated by YouTube.. unfortunately only in 360p and with the language tracks removed, but here it is - https://www.youtube.com/watch?v=bRGrKJofDaw\", \"publishedAt\": \"2024-03-31T21:14:03Z\", \"statistics\": {\"viewCount\": \"1540670\", \"likeCount\": \"123586\", \"favoriteCount\": \"0\", \"commentCount\": \"8815\"}}, {\"id\": \"bRGrKJofDaw\", \"title\": \"Vegas Tunnels\", \"description\": \"To watch our new episode, 'D.A.R.E. Conference,' go to our Patreon, https://www.patreon.com/channel5. \\n\\nAlso, tickets for my my upcoming movie screening for 'Untitled Andrew Callaghan Film' in Boston are now available at https://chevaliertheatre.com/.\\n\\nThis documentary is also available in 5 different languages! To hear 'Vegas Tunnels' in either Spanish, German, French, Japanese, or Brazilian Portguese, click the settings icon in the bottom right corner of your YouTube player and select 'Audio Track,' for the option to toggle between languages.\", \"publishedAt\": \"2024-03-28T18:00:10Z\", \"statistics\": {\"viewCount\": \"5939736\", \"likeCount\": \"154425\", \"favoriteCount\": \"0\", \"commentCount\": \"12457\"}}, {\"id\": \"2sRvgsJbKgI\", \"title\": \"Defend the Border Convoy\", \"description\": \"To check out our Spanish-translation channel, go to  @CanalCincoNews\", \"publishedAt\": \"2024-02-29T21:53:29Z\", \"statistics\": {\"viewCount\": \"2261402\", \"likeCount\": \"76085\", \"favoriteCount\": \"0\", \"commentCount\": \"10872\"}}, {\"id\": \"M5MxAMKmXAM\", \"title\": \"Border Patrol Arrest\", \"description\": \"This video covers Andrew's extended detention at a Border Patrol detention facility in Eagle Pass, TX alongside other migrants as told through digital VFX, an in-studio interview, and the stories of his additional cameramen, Elliot Leidgren and Juan Jimenez. \\n\\nTo get an exclusive peek at our next video, 'Defend the Border Convoy,' go to our Patreon - https://www.patreon.com/channel5. It's about $5/month but as many of you know, we are primarily crowdfunded through your contributions.\", \"publishedAt\": \"2024-02-14T22:47:07Z\", \"statistics\": {\"viewCount\": \"2374076\", \"likeCount\": \"102230\", \"favoriteCount\": \"0\", \"commentCount\": \"7053\"}}, {\"id\": \"ponylQTj_gg\", \"title\": \"Hopping the Border\", \"description\": \"To see our first graphically animated episode, 'Border Patrol Arrest,' go to https://www.patreon.com/channel5\", \"publishedAt\": \"2024-02-07T21:00:26Z\", \"statistics\": {\"viewCount\": \"2010779\", \"likeCount\": \"98101\", \"favoriteCount\": \"0\", \"commentCount\": \"6954\"}}, {\"id\": \"akrF8X0KgGg\", \"title\": \"Texas Border Crisis\", \"description\": \"In this episode, we'll explore the ongoing migrant crisis at the U.S.-Mexico Border in Eagle Pass, Texas, then travel into Mexico to shadow human smugglers, or 'coyotes,' across the Rio Grande in Piedras Negras, MX. To see our episode, 'Hopping the Border,' go to our Patreon, https://www.patreon.com/channel5\", \"publishedAt\": \"2024-02-01T20:44:32Z\", \"statistics\": {\"viewCount\": \"1862153\", \"likeCount\": \"63058\", \"favoriteCount\": \"0\", \"commentCount\": \"4335\"}}, {\"id\": \"V0GCKEvWhso\", \"title\": \"Ocean City Streets\", \"description\": \"Get our exclusive NordVPN deal here at https://NordVPN.com/channel5 .. It\\u2019s risk free with Nord\\u2019s 30 day money-back guarantee.\\n\\nAlso, 'Ocean City Nights' is currently available exclusively on our Patreon, https://www.patreon.com/channel5/posts.\\n\\nAn if you'd like to subscribe to our new Spanish-Language channel, 'Canal Cinco,' here it is. https://www.youtube.com/channel/UCETll0V0gFDjKvW-N-8Bq-Q\\n\\nFurthermore, if you'd like to apply to work at Channel 5, go to https://channel5.news/pages/submissions\", \"publishedAt\": \"2024-01-26T22:43:50Z\", \"statistics\": {\"viewCount\": \"2211141\", \"likeCount\": \"66632\", \"favoriteCount\": \"0\", \"commentCount\": \"4715\"}}, {\"id\": \"2dQ4-VNaG3s\", \"title\": \"Migrant Detention Camp\", \"description\": \"To see us shadow 'coyotes' on the Mexican side of the border, go to our Patreon, https://www.patreon.com/channel5, where you'll find our new episode, \\\"Texas Border Crisis.\\\"\\n\\nAs many of you may know, our Patreon is $5/month, but it supports our entire independent production budget.\", \"publishedAt\": \"2024-01-22T00:22:12Z\", \"statistics\": {\"viewCount\": \"2462053\", \"likeCount\": \"78518\", \"favoriteCount\": \"0\", \"commentCount\": \"13414\"}}, {\"id\": \"pTDE19GrvTI\", \"title\": \"Crip Mac Returns to Prison\", \"description\": \"In this video, we sit down with China Mac, Lupe46, Granny Bear, Mama Bear, Adam22, and Defense Attorney Michael Freedman to discuss Crip Mac's case. To contribute to Crip Mac's GoFundMe, visit - https://www.gofundme.com/f/crip-mac-legal-defense-fund\", \"publishedAt\": \"2024-01-15T20:59:42Z\", \"statistics\": {\"viewCount\": \"1940330\", \"likeCount\": \"61648\", \"favoriteCount\": \"0\", \"commentCount\": \"8415\"}}, {\"id\": \"buZWVQuqx0o\", \"title\": \"Arizona Border Crisis\", \"description\": \"Here is the first installment of our coverage of the ongoing Border Crisis, filmed mostly in Gringo Pass, AZ. Our next installment, 'Migrant Detention Facility,' is currently available exclusively on our Patreon, https://www.patreon.com/channel5\", \"publishedAt\": \"2024-01-12T23:09:38Z\", \"statistics\": {\"viewCount\": \"1937022\", \"likeCount\": \"94976\", \"favoriteCount\": \"0\", \"commentCount\": \"6886\"}}, {\"id\": \"925wmb-4Yr4\", \"title\": \"Philly Streets\", \"description\": \"Here is our coverage of Kensington, an open-air drug market in Philadelphia. If you'd like a chance of pace, our new episode 'Ocean City' streets is available exclusively on our Patreon, https://www.patreon.com/channel5.\\n\\nAlso, thank you to fellow reporter  @TommyGMcGee  for linking us up with the fixer that made all of this possible.\", \"publishedAt\": \"2024-01-09T21:22:07Z\", \"statistics\": {\"viewCount\": \"7750158\", \"likeCount\": \"199364\", \"favoriteCount\": \"0\", \"commentCount\": \"21945\"}}, {\"id\": \"Ym7qS27oiHU\", \"title\": \"Harm Reduction Facility\", \"description\": \"If you enjoyed this video, please donate to Antonio's GoFundMe to save Lost Soul Courier Collective: https://www.gofundme.com/f/help-lost-soul-courier-co-save-276?member=30998321&sharetype=teams&utm_campaign=p_na+share-sheet&utm_medium=copy_link&utm_source=customer\", \"publishedAt\": \"2023-12-08T19:55:32Z\", \"statistics\": {\"viewCount\": \"1838062\", \"likeCount\": \"75838\", \"favoriteCount\": \"0\", \"commentCount\": \"8469\"}}, {\"id\": \"lLGRGZTk51w\", \"title\": \"Jack the Bipper\", \"description\": \"If you\\u2019re ever injured in an accident, you can check out Morgan & Morgan. You can submit a claim in 8 clicks or less without having to leave your couch. To start your claim, visit https://www.forthepeople.com/channel5\", \"publishedAt\": \"2023-12-01T23:01:17Z\", \"statistics\": {\"viewCount\": \"3143523\", \"likeCount\": \"103718\", \"favoriteCount\": \"0\", \"commentCount\": \"10038\"}}, {\"id\": \"URfCwT3UQy4\", \"title\": \"San Francisco Streets\", \"description\": \"\", \"publishedAt\": \"2023-11-22T21:10:11Z\", \"statistics\": {\"viewCount\": \"7846159\", \"likeCount\": \"240511\", \"favoriteCount\": \"0\", \"commentCount\": \"20509\"}}, {\"id\": \"qzC28hBsSkA\", \"title\": \"Toronto Mans\", \"description\": \"In this video, we check out the humans of Toronto \\u2014 Featuring interviews with Sagi Shawty, Bucks b Ballin, Plushh, and Kyle foregard.\", \"publishedAt\": \"2023-11-12T22:58:43Z\", \"statistics\": {\"viewCount\": \"3318188\", \"likeCount\": \"97830\", \"favoriteCount\": \"0\", \"commentCount\": \"6738\"}}, {\"id\": \"gPPKvSXml_s\", \"title\": \"Calgary Stampede\", \"description\": \"\", \"publishedAt\": \"2023-11-05T22:55:12Z\", \"statistics\": {\"viewCount\": \"1780645\", \"likeCount\": \"44292\", \"favoriteCount\": \"0\", \"commentCount\": \"3297\"}}]}"}
    
    # with open("analytics-out.txt", "w", encoding="utf-8") as f:
    #     f.write(str(analytics))

    # Create a JSON splitter, create the doc, add to vector DB
    json_splitter = RecursiveJsonSplitter()
    json_splits = json_splitter.split_text(analytics)

    print(len(json_splits))

    json_doc = json_splitter.create_documents(json_splits)
    doc_ids = vector_store.add_documents(json_doc)


def retrieve_and_prompt(query):
    """
    Retrieve and prompt LLM 
    """
    # Define prompt for question-answering
    template = ("""You are an assistant for question-answering tasks on Youtube Analytics. 
                The Context provided will be channel and video statistics published on the channel.
                Use the following pieces of retrieved context to answer the question. If you don't know the answer, just say that you don't know. Use five sentences maximum and keep the answer concise.
                    Question: {query} 
                    Context: {context} 
                    Answer:""")

    prompt = ChatPromptTemplate.from_template(template)
    retrieved_docs = vector_store.similarity_search(query)
    print(f"retreived len: {len(retrieved_docs)}")
    # print(f"retreived: {retrieved_docs}")

    prompt = prompt.invoke({"query": query, "context": retrieved_docs})
    answer = llm.invoke(prompt)

    return answer
